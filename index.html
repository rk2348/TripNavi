<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—…ã®ãƒ—ãƒ©ãƒ³æ•´ç†ãƒ¡ãƒ¢ - çµ±åˆç‰ˆ</title>
  <style>
    :root {
      --primary-color: #2C3E50;
      --accent-color: #E74C3C;
      --bg-color: #F4F7F6;
      --card-bg: #FFFFFF;
      --text-color: #333333;
      --sync-color: #27AE60;
      --border-color: #E0E0E0;
    }
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      margin: 0;
      padding: 0; /* ãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®šã®ãŸã‚èª¿æ•´ */
    }
    
    /* ä¸Šéƒ¨å›ºå®šã®æ“ä½œãƒ‘ãƒãƒ«ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ */
    .sticky-header {
      position: sticky;
      top: 0;
      background-color: #ffffff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 20px;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .header-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sync-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: #E8F5E9;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--sync-color);
    }
    .sync-controls input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 150px;
    }
    .sync-status {
      font-size: 0.85rem;
      font-weight: bold;
      color: var(--sync-color);
      margin-left: 10px;
      display: none;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 1fr 1fr; /* PCã§ã¯2ã‚«ãƒ©ãƒ  */
      gap: 20px;
    }
    
    /* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã¯1ã‚«ãƒ©ãƒ ã«ã™ã‚‹ */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      .sticky-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      border: 1px solid var(--border-color);
    }
    .card.full-width {
      grid-column: 1 / -1; /* å…¨å¹…ã‚’ä½¿ã† */
    }
    .card h2 {
      margin-top: 0;
      border-bottom: 3px solid var(--primary-color);
      padding-bottom: 10px;
      font-size: 1.25rem;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 0.9rem;
      color: #555;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    input:focus, textarea:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.1);
    }
    textarea {
      resize: vertical;
      min-height: 120px;
    }
    .row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .row .form-group {
      flex: 1;
      min-width: 180px;
    }
    
    /* æ—¥ç¨‹åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .schedule-day {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary-color);
    }
    .schedule-day h3 {
      margin-top: 0;
      font-size: 1rem;
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    /* æŒã¡ç‰©ãƒªã‚¹ãƒˆç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .checklist-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    .checklist-item {
      display: flex;
      align-items: center;
      font-size: 0.95rem;
      background-color: #fcfcfc;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #eee;
    }
    .checklist-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
    }
    .checklist-item input[type="text"] {
      padding: 4px 8px;
      margin-left: 5px;
      width: calc(100% - 30px);
      border: none;
      background: transparent;
      border-bottom: 1px dashed #ccc;
      border-radius: 0;
    }

    /* è²»ç”¨è¨ˆç®—ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .cost-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .total-box {
      background-color: #E8F4FD;
      padding: 20px;
      border-radius: 8px;
      text-align: right;
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-top: 15px;
      border-left: 5px solid #3498DB;
    }
    .total-box input {
      background: transparent;
      border: none;
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--primary-color);
      text-align: right;
      width: 150px;
      padding: 0;
    }
    .per-person {
      font-size: 1rem;
      color: #e67e22;
      margin-top: 10px;
    }
    .per-person input {
      font-size: 1.4rem;
      color: #e67e22;
      width: 120px;
    }

    /* ãƒœã‚¿ãƒ³ç¾¤ */
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: bold;
      transition: opacity 0.3s;
    }
    button:hover {
      opacity: 0.8;
    }
    .btn-sync { background-color: var(--sync-color); }
    .btn-refresh { background-color: #3498DB; display: flex; align-items: center; gap: 5px; }
    .btn-danger { background-color: var(--accent-color); }
    
    .bottom-actions {
      grid-column: 1 / -1;
      text-align: center;
      margin-top: 20px;
      margin-bottom: 50px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }
    
    /* å°åˆ·æ™‚ã®è¨­å®š */
    @media print {
      body { background-color: white; padding: 0; }
      .sticky-header, .bottom-actions { display: none; }
      .container { display: block; }
      .card { box-shadow: none; border: 1px solid #000; margin-bottom: 20px; page-break-inside: avoid; }
      input, textarea { border: none; background: transparent; resize: none; }
      input[type="number"] { -moz-appearance: textfield; }
      input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    }
  </style>
</head>
<body>

  <div class="sticky-header">
    <div class="header-title">âœˆï¸ æ—…ã®ãƒ—ãƒ©ãƒ³æ•´ç†ãƒ¡ãƒ¢</div>
    <div class="sync-controls">
      <label for="share-id" style="margin:0; font-size:0.85rem;">å…±æœ‰ID:</label>
      <input type="text" id="share-id" placeholder="ä¾‹ï¼škanazawa-tokyo">
      <button id="btn-start-sync" class="btn-sync">åŒæœŸ</button>
      <button id="btn-refresh" class="btn-refresh">ğŸ”„ æœ€æ–°ã‚’å–å¾—</button>
      <span id="sync-status-text" class="sync-status">âœ… è‡ªå‹•åŒæœŸä¸­</span>
    </div>
  </div>

  <div class="container">
    
    <div class="column-left" style="display: flex; flex-direction: column; gap: 20px;">
      
      <div class="card">
        <h2>ğŸ“ åŸºæœ¬æƒ…å ±</h2>
        <div class="form-group">
          <label for="trip-title">æ—…è¡Œã®ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ç›®çš„åœ°</label>
          <input type="text" id="trip-title" class="shared-data" placeholder="ä¾‹ï¼šçŸ³å·ã€œæ±äº¬ 2æ³Š3æ—¥æ—…è¡Œ">
        </div>
        <div class="row">
          <div class="form-group">
            <label for="date-start">å‡ºç™ºæ—¥</label>
            <input type="date" id="date-start" class="shared-data">
          </div>
          <div class="form-group">
            <label for="date-end">å¸°å®…æ—¥</label>
            <input type="date" id="date-end" class="shared-data">
          </div>
          <div class="form-group" style="flex: 0.5;">
            <label for="trip-people">å‚åŠ äººæ•°ï¼ˆäººï¼‰</label>
            <input type="number" id="trip-people" class="cost-input shared-data" placeholder="4" min="1" value="4">
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ—ºï¸ æ—¥ç¨‹è¡¨ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
        
        <div class="schedule-day">
          <h3>Day 1ï¼ˆ1æ—¥ç›®ï¼‰</h3>
          <textarea id="schedule-day1" class="shared-data" placeholder="ä¾‹ï¼š&#10;22:30 é‡‘æ²¢é§…è¥¿å£ é›†åˆ&#10;23:00 å¤œè¡Œãƒã‚¹å‡ºç™º"></textarea>
        </div>
        
        <div class="schedule-day">
          <h3>Day 2ï¼ˆ2æ—¥ç›®ï¼‰</h3>
          <textarea id="schedule-day2" class="shared-data" placeholder="ä¾‹ï¼š&#10;06:30 ãƒã‚¹ã‚¿æ–°å®¿ åˆ°ç€&#10;10:00 ã€‡ã€‡ã§è¦³å…‰&#10;15:00 ãƒ›ãƒ†ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³"></textarea>
        </div>

        <div class="schedule-day">
          <h3>Day 3ï¼ˆ3æ—¥ç›®ï¼‰</h3>
          <textarea id="schedule-day3" class="shared-data" placeholder="ä¾‹ï¼š&#10;10:00 ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ&#10;23:30 ãƒã‚¹ã‚¿æ–°å®¿ç™º ãƒã‚¹ä¹—è»Š"></textarea>
        </div>
      </div>
    </div> <div class="column-right" style="display: flex; flex-direction: column; gap: 20px;">
      
      <div class="card">
        <h2>ğŸšŒ äº¤é€šã‚¢ã‚¯ã‚»ã‚¹ï¼ˆå¤œè¡Œãƒã‚¹ãƒ»æ–°å¹¹ç·šãªã©ï¼‰</h2>
        <div class="row">
          <div class="form-group">
            <label for="bus-depart-time">ã€è¡Œãã€‘ä¹—è»Šæ™‚é–“ãƒ»å ´æ‰€</label>
            <input type="text" id="bus-depart-time" class="shared-data" placeholder="23:00 é‡‘æ²¢é§…è¥¿å£">
          </div>
          <div class="form-group">
            <label for="bus-arrive-time">ã€è¡Œãã€‘åˆ°ç€æ™‚é–“ãƒ»å ´æ‰€</label>
            <input type="text" id="bus-arrive-time" class="shared-data" placeholder="06:30 ãƒã‚¹ã‚¿æ–°å®¿">
          </div>
        </div>
        <div class="row" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc;">
          <div class="form-group">
            <label for="bus-return-time">ã€å¸°ã‚Šã€‘ä¹—è»Šæ™‚é–“ãƒ»å ´æ‰€</label>
            <input type="text" id="bus-return-time" class="shared-data" placeholder="23:30 ãƒã‚¹ã‚¿æ–°å®¿">
          </div>
          <div class="form-group">
            <label for="bus-return-arrive">ã€å¸°ã‚Šã€‘åˆ°ç€æ™‚é–“ãƒ»å ´æ‰€</label>
            <input type="text" id="bus-return-arrive" class="shared-data" placeholder="07:00 é‡‘æ²¢é§…">
          </div>
        </div>
        <div class="form-group" style="margin-top: 10px;">
          <label for="bus-url">äºˆç´„ã‚µã‚¤ãƒˆã®URLãƒ»äºˆç´„ç•ªå·</label>
          <input type="text" id="bus-url" class="shared-data" placeholder="URLã‚„ã€äºˆç´„ç•ªå·123456 ãªã©">
        </div>
      </div>

      <div class="card">
        <h2>ğŸ¨ å®¿æ³Šæ–½è¨­</h2>
        <div class="form-group">
          <label for="hotel-name">ãƒ›ãƒ†ãƒ«ãƒ»å®¿ã®åå‰</label>
          <input type="text" id="hotel-name" class="shared-data" placeholder="ä¾‹ï¼šãƒ›ãƒ†ãƒ«ã€‡ã€‡æ±äº¬">
        </div>
        <div class="row">
          <div class="form-group">
            <label for="check-in">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</label>
            <input type="time" id="check-in" class="shared-data">
          </div>
          <div class="form-group">
            <label for="check-out">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</label>
            <input type="time" id="check-out" class="shared-data">
          </div>
        </div>
        <div class="form-group">
          <label for="hotel-address">ä½æ‰€ãƒ»ã‚¢ã‚¯ã‚»ã‚¹ / äºˆç´„ç•ªå·</label>
          <input type="text" id="hotel-address" class="shared-data" placeholder="ä½æ‰€ã€URLã€äºˆç´„ç•ªå·ãªã©">
        </div>
      </div>

      <div class="card">
        <h2>ğŸ’´ è²»ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
        <div class="cost-grid">
          <div class="form-group">
            <label for="cost-transport">äº¤é€šè²»ï¼ˆç·é¡ï¼‰</label>
            <input type="number" id="cost-transport" class="cost-calc shared-data" placeholder="0" min="0">
          </div>
          <div class="form-group">
            <label for="cost-hotel">å®¿æ³Šè²»ï¼ˆç·é¡ï¼‰</label>
            <input type="number" id="cost-hotel" class="cost-calc shared-data" placeholder="0" min="0">
          </div>
          <div class="form-group">
            <label for="cost-food">é£Ÿè²»ãƒ»å®´ä¼šä»£ï¼ˆç·é¡ï¼‰</label>
            <input type="number" id="cost-food" class="cost-calc shared-data" placeholder="0" min="0">
          </div>
          <div class="form-group">
            <label for="cost-activity">è¦³å…‰ãƒ»ãƒã‚±ãƒƒãƒˆä»£ï¼ˆç·é¡ï¼‰</label>
            <input type="number" id="cost-activity" class="cost-calc shared-data" placeholder="0" min="0">
          </div>
        </div>
        <div class="total-box">
          æ—…è¡Œå…¨ä½“ã®æ¦‚ç®—åˆè¨ˆï¼š <input type="text" id="cost-total" readonly value="0"> å††
          <div class="per-person">
            ï¼ˆ1äººã‚ãŸã‚Šï¼šç´„ <input type="text" id="cost-per-person" readonly value="0"> å††ï¼‰
          </div>
        </div>
      </div>

    </div> <div class="card full-width">
      <h2>ğŸ’ æŒã¡ç‰©ãƒªã‚¹ãƒˆï¼ˆâ€»è‡ªåˆ†å°‚ç”¨ãƒ¡ãƒ¢ / å…±æœ‰ã•ã‚Œã¾ã›ã‚“ï¼‰</h2>
      <div class="checklist-group">
        <label class="checklist-item"><input type="checkbox" id="chk-1" class="private-data"> è²¡å¸ƒãƒ»èº«åˆ†è¨¼</label>
        <label class="checklist-item"><input type="checkbox" id="chk-2" class="private-data"> ã‚¹ãƒãƒ›ãƒ»ãƒ¢ãƒã‚¤ãƒ«ãƒãƒƒãƒ†ãƒªãƒ¼</label>
        <label class="checklist-item"><input type="checkbox" id="chk-3" class="private-data"> ç€æ›¿ãˆãƒ»ä¸‹ç€é¡</label>
        <label class="checklist-item"><input type="checkbox" id="chk-4" class="private-data"> æ´—é¢ãƒ»ã‚¹ã‚­ãƒ³ã‚±ã‚¢ç”¨å“</label>
        <label class="checklist-item"><input type="checkbox" id="chk-5" class="private-data"> å¸¸å‚™è–¬ãƒ»ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ</label>
        <label class="checklist-item"><input type="checkbox" id="chk-6" class="private-data"> ãƒ‘ã‚¸ãƒ£ãƒãƒ»éƒ¨å±‹ç€</label>
        <label class="checklist-item"><input type="checkbox" id="chk-7" class="private-data"> æŠ˜ã‚ŠãŸãŸã¿å‚˜</label>
        <label class="checklist-item"><input type="checkbox" id="chk-8" class="private-data"> ãƒ“ãƒ‹ãƒ¼ãƒ«è¢‹ãƒ»ã‚¨ã‚³ãƒãƒƒã‚°</label>
        
        <div class="checklist-item"><input type="checkbox" id="chk-free-1" class="private-data"><input type="text" id="txt-free-1" class="private-data" placeholder="è‡ªç”±ã«å…¥åŠ›"></div>
        <div class="checklist-item"><input type="checkbox" id="chk-free-2" class="private-data"><input type="text" id="txt-free-2" class="private-data" placeholder="è‡ªç”±ã«å…¥åŠ›"></div>
        <div class="checklist-item"><input type="checkbox" id="chk-free-3" class="private-data"><input type="text" id="txt-free-3" class="private-data" placeholder="è‡ªç”±ã«å…¥åŠ›"></div>
        <div class="checklist-item"><input type="checkbox" id="chk-free-4" class="private-data"><input type="text" id="txt-free-4" class="private-data" placeholder="è‡ªç”±ã«å…¥åŠ›"></div>
      </div>
    </div>

    <div class="bottom-actions">
      <button onclick="window.print()" style="background-color: #7f8c8d;">ğŸ–¨ï¸ PDFä¿å­˜ / å°åˆ·ã—ã¦ã—ãŠã‚Šã«ã™ã‚‹</button>
      <button class="btn-danger" id="btn-clear-data" style="margin-left: 15px;">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

  </div> <script type="module">
    // Firebaseãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆgeté–¢æ•°ã‚’æ–°ãŸã«è¿½åŠ ï¼‰
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    // ã„ãŸã ã„ãŸæƒ…å ± ï¼‹ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹URLã‚’è¿½åŠ ã—ãŸè¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCQ5Dig1lRAz3GihBnWFJBgHTLD864QWpg",
      authDomain: "tripnavi-6363a.firebaseapp.com",
      databaseURL: "https://tripnavi-6363a-default-rtdb.firebaseio.com",
      projectId: "tripnavi-6363a",
      storageBucket: "tripnavi-6363a.firebasestorage.app",
      messagingSenderId: "946828759773",
      appId: "1:946828759773:web:990ff142a2744c55b24134"
    };

    let app, db;
    let currentSyncId = null;
    let isSyncing = false;

    // è¦ç´ ã®å–å¾—
    const sharedInputs = document.querySelectorAll('.shared-data');
    const privateInputs = document.querySelectorAll('.private-data');
    const allInputs = document.querySelectorAll('input:not(#share-id):not(#cost-total):not(#cost-per-person), textarea');

    // è²»ç”¨ã®åˆè¨ˆã¨ã€1äººã‚ãŸã‚Šã®é‡‘é¡ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    function calculateTotal() {
      let total = 0;
      // .cost-calc ã‚¯ãƒ©ã‚¹ã‚’æŒã¤å…¥åŠ›æ¬„ã‚’åˆç®—
      document.querySelectorAll('.cost-calc').forEach(input => {
        const val = parseInt(input.value, 10);
        if (!isNaN(val)) total += val;
      });
      document.getElementById('cost-total').value = total.toLocaleString();

      // äººæ•°ã§å‰²ã£ã¦1äººã‚ãŸã‚Šã®é‡‘é¡ã‚’è¨ˆç®—
      const peopleInput = document.getElementById('trip-people').value;
      const people = parseInt(peopleInput, 10);
      if (!isNaN(people) && people > 0) {
        const perPerson = Math.ceil(total / people); // åˆ‡ã‚Šä¸Šã’
        document.getElementById('cost-per-person').value = perPerson.toLocaleString();
      } else {
        document.getElementById('cost-per-person').value = "0";
      }
    }

    // åŒæœŸå‡¦ç†ã‚’ã¾ã¨ã‚ãŸé–¢æ•°ï¼ˆisAutoãŒtrueã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã•ãªã„ï¼‰
    function startSync(shareId, isAuto = false) {
      if (!app) {
        try {
          app = initializeApp(firebaseConfig);
          db = getDatabase(app);
        } catch (error) {
          if (!isAuto) alert("Firebaseã®æ¥ç¶šã‚¨ãƒ©ãƒ¼ã§ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          console.error(error);
          return;
        }
      }

      currentSyncId = shareId;
      isSyncing = true;
      
      // æ¬¡å›è‡ªå‹•åŒæœŸã®ãŸã‚ã«IDã‚’ä¿å­˜
      localStorage.setItem('savedSyncId', shareId);
      
      document.getElementById('sync-status-text').style.display = 'inline-block';
      
      const tripRef = ref(db, 'trips/' + currentSyncId);
      const initialData = {};
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã«çµ±åˆ
      sharedInputs.forEach(input => {
        if (input.value) initialData[input.id] = input.value;
      });
      if (Object.keys(initialData).length > 0) {
        update(tripRef, initialData);
      }

      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ï¼ˆèª°ã‹ãŒæ›´æ–°ã—ãŸã‚‰è‡ªå‹•åæ˜ ï¼‰
      onValue(tripRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          sharedInputs.forEach(input => {
            // è‡ªåˆ†ãŒä»Šå…¥åŠ›ä¸­ã®é …ç›®ã¯ä¸Šæ›¸ãã—ãªã„ï¼ˆã‚«ãƒ¼ã‚½ãƒ«é£›ã³é˜²æ­¢ï¼‰
            if (data[input.id] !== undefined && document.activeElement !== input) {
              input.value = data[input.id];
              localStorage.setItem(input.id, input.value);
            }
          });
          calculateTotal();
        }
      });
      
      if (!isAuto) {
        alert(`IDã€Œ${shareId}ã€ã§åŒæœŸã‚’é–‹å§‹ã—ã¾ã—ãŸï¼`);
      }
    }

    // ====== æ–°æ©Ÿèƒ½ï¼šæ‰‹å‹•ã§æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹æ©Ÿèƒ½ ======
    document.getElementById('btn-refresh').addEventListener('click', () => {
      if (!isSyncing || !currentSyncId) {
        alert("åŒæœŸãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…±æœ‰IDã‚’å…¥åŠ›ã—ã¦åŒæœŸã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      
      const tripRef = ref(db, 'trips/' + currentSyncId);
      
      // get() ã‚’ä½¿ã£ã¦Firebaseã‹ã‚‰å¼·åˆ¶çš„ã«æœ€æ–°ã®1å›åˆ†ã‚’å–å¾—
      get(tripRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          sharedInputs.forEach(input => {
            if (data[input.id] !== undefined) {
              input.value = data[input.id];
              localStorage.setItem(input.id, input.value);
            }
          });
          calculateTotal();
          // ãƒœã‚¿ãƒ³ã®æ–‡å­—ã‚’ä¸€ç¬å¤‰ãˆã¦è¦–è¦šçš„ã«å®Œäº†ã‚’ä¼ãˆã‚‹
          const btn = document.getElementById('btn-refresh');
          const originalText = btn.innerHTML;
          btn.innerHTML = "âœ¨ æ›´æ–°å®Œäº†ï¼";
          setTimeout(() => { btn.innerHTML = originalText; }, 2000);
        } else {
          alert("å…±æœ‰ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
      }).catch((error) => {
        console.error(error);
        alert("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      });
    });
    // ===================================================

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', () => {
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
      allInputs.forEach(input => {
        const savedData = localStorage.getItem(input.id);
        if (savedData !== null) {
          if (input.type === 'checkbox') {
            input.checked = (savedData === 'true');
          } else {
            input.value = savedData;
          }
        }
      });
      calculateTotal();

      // è‡ªå‹•åŒæœŸã®ãƒã‚§ãƒƒã‚¯
      const savedSyncId = localStorage.getItem('savedSyncId');
      if (savedSyncId) {
        document.getElementById('share-id').value = savedSyncId;
        startSync(savedSyncId, true); // è‡ªå‹•åŒæœŸé–‹å§‹ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆãªã—ï¼‰
      }
    });

    // å…¥åŠ›æ™‚ã®å‡¦ç†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‹Firebaseé€ä¿¡ï¼‰
    allInputs.forEach(input => {
      input.addEventListener('input', () => {
        if (input.type === 'checkbox') {
          localStorage.setItem(input.id, input.checked);
        } else {
          localStorage.setItem(input.id, input.value);
        }

        // è²»ç”¨é–¢ä¿‚ã‚„äººæ•°ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰å†è¨ˆç®—
        if (input.classList.contains('cost-calc') || input.id === 'trip-people') {
          calculateTotal();
        }

        if (isSyncing && input.classList.contains('shared-data')) {
          const tripRef = ref(db, 'trips/' + currentSyncId);
          update(tripRef, { [input.id]: input.value });
        }
      });
    });

    // æ‰‹å‹•ã§åŒæœŸã‚’é–‹å§‹ã™ã‚‹ãƒœã‚¿ãƒ³
    document.getElementById('btn-start-sync').addEventListener('click', () => {
      const shareId = document.getElementById('share-id').value.trim();
      if (!shareId) {
        alert("å…±æœ‰IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      startSync(shareId, false);
    });

    // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆå‡¦ç†
    document.getElementById('btn-clear-data').addEventListener('click', () => {
      if (confirm('å…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆâ€»åŒæœŸä¸­ã®å ´åˆã€å…±æœ‰å…ˆã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆå»ã•ã‚Œã¾ã™ï¼‰')) {
        allInputs.forEach(input => {
          if (input.type === 'checkbox') {
            input.checked = false;
          } else if (input.id === 'trip-people') {
            input.value = '4'; // äººæ•°ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®4ã«æˆ»ã™
          } else {
            input.value = '';
          }
          localStorage.removeItem(input.id);
        });
        
        // ä¿å­˜ã—ãŸåŒæœŸIDã‚‚å‰Šé™¤ã™ã‚‹
        localStorage.removeItem('savedSyncId');
        document.getElementById('share-id').value = '';
        document.getElementById('sync-status-text').style.display = 'none';

        calculateTotal();

        if (isSyncing && currentSyncId) {
          const tripRef = ref(db, 'trips/' + currentSyncId);
          remove(tripRef);
        }
        
        isSyncing = false;
        currentSyncId = null;
        window.scrollTo(0, 0);
      }
    });
  </script>
</body>
</html>