<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—…ã®ãƒ—ãƒ©ãƒ³æ•´ç†ãƒ¡ãƒ¢ - çµ±åˆç‰ˆ</title>
  <style>
    :root {
      --primary-color: #2C3E50;
      --accent-color: #E74C3C;
      --bg-color: #F4F7F6;
      --card-bg: #FFFFFF;
      --text-color: #333333;
      --sync-color: #27AE60;
      --border-color: #E0E0E0;
    }
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }
    
    /* ä¸Šéƒ¨å›ºå®šã®æ“ä½œãƒ‘ãƒãƒ«ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ */
    .sticky-header {
      position: sticky;
      top: 0;
      background-color: #ffffff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px 20px;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .header-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sync-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: #E8F5E9;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid var(--sync-color);
    }
    .sync-controls input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 150px;
    }
    .sync-status {
      font-size: 0.85rem;
      font-weight: bold;
      color: var(--sync-color);
      margin-left: 10px;
      display: none;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: 1fr 1fr; /* PCã§ã¯2ã‚«ãƒ©ãƒ  */
      gap: 20px;
    }
    
    /* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã¯1ã‚«ãƒ©ãƒ ã«ã™ã‚‹ */
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
      .sticky-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.03);
      border: 1px solid var(--border-color);
    }
    .card.full-width {
      grid-column: 1 / -1; /* å…¨å¹…ã‚’ä½¿ã† */
    }
    .card h2 {
      margin-top: 0;
      border-bottom: 3px solid var(--primary-color);
      padding-bottom: 10px;
      font-size: 1.25rem;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 0.9rem;
      color: #555;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-family: inherit;
      transition: border-color 0.3s;
    }
    input:focus, textarea:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(44, 62, 80, 0.1);
    }
    textarea {
      resize: vertical;
      min-height: 120px;
    }
    .row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .row .form-group {
      flex: 1;
      min-width: 180px;
    }
    
    /* æ—¥ç¨‹åˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .schedule-day {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary-color);
    }
    .schedule-day h3 {
      margin-top: 0;
      font-size: 1rem;
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    /* æŒã¡ç‰©ãƒªã‚¹ãƒˆç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .checklist-group {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    .checklist-item {
      display: flex;
      align-items: center;
      font-size: 0.95rem;
      background-color: #fcfcfc;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #eee;
    }
    .checklist-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      cursor: pointer;
    }
    .checklist-item label {
      margin: 0;
      font-weight: normal;
      color: var(--text-color);
      flex: 1;
      cursor: pointer;
    }
    .btn-delete-item {
      background: transparent;
      color: #bbb;
      border: none;
      padding: 0 5px;
      font-size: 1.2rem;
      cursor: pointer;
      margin-left: auto;
      transition: color 0.2s;
    }
    .btn-delete-item:hover {
      color: var(--accent-color);
      background: transparent;
      opacity: 1;
    }

    /* è²»ç”¨è¨ˆç®—ç”¨ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .cost-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .total-box {
      background-color: #E8F4FD;
      padding: 20px;
      border-radius: 8px;
      text-align: right;
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary-color);
      margin-top: 15px;
      border-left: 5px solid #3498DB;
    }
    .total-box input {
      background: transparent;
      border: none;
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--primary-color);
      text-align: right;
      width: 150px;
      padding: 0;
    }
    .per-person {
      font-size: 1rem;
      color: #e67e22;
      margin-top: 10px;
    }
    .per-person input {
      font-size: 1.4rem;
      color: #e67e22;
      width: 120px;
    }

    /* ãƒœã‚¿ãƒ³ç¾¤ */
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: bold;
      transition: opacity 0.3s;
    }
    button:hover {
      opacity: 0.8;
    }
    .btn-sync { background-color: var(--sync-color); }
    .btn-refresh { background-color: #3498DB; display: flex; align-items: center; gap: 5px; }
    .btn-danger { background-color: var(--accent-color); }
    
    .bottom-actions {
      grid-column: 1 / -1;
      text-align: center;
      margin-top: 20px;
      margin-bottom: 50px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }
    
    /* å°åˆ·æ™‚ã®è¨­å®š */
    @media print {
      body { background-color: white; padding: 0; }
      .sticky-header, .bottom-actions { display: none; }
      .container { display: block; }
      .card { box-shadow: none; border: 1px solid #000; margin-bottom: 20px; page-break-inside: avoid; }
      input, textarea { border: none; background: transparent; resize: none; }
      input[type="number"] { -moz-appearance: textfield; }
      input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
      .btn-delete-item, #new-item-text, #btn-add-item { display: none; } /* å°åˆ·æ™‚ã¯è¿½åŠ ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éš ã™ */
    }
  </style>
</head>
<body>

  <div class="sticky-header">
    <div class="header-title">âœˆï¸ æ—…ã®ãƒ—ãƒ©ãƒ³æ•´ç†ãƒ¡ãƒ¢</div>
    <div class="sync-controls">
      <label for="share-id" style="margin:0; font-size:0.85rem;">å…±æœ‰ID:</label>
      <input type="text" id="share-id" placeholder="ä¾‹ï¼škanazawa-tokyo">
      <button id="btn-start-sync" class="btn-sync">åŒæœŸ</button>
      <button id="btn-refresh" class="btn-refresh">ğŸ”„ æœ€æ–°ã‚’å–å¾—</button>
      <span id="sync-status-text" class="sync-status">âœ… è‡ªå‹•åŒæœŸä¸­</span>
    </div>
  </div>

  <div class="container">
    
    <div class="column-left" style="display: flex; flex-direction: column; gap: 20px;">
      
      <div class="card">
        <h2>ğŸ“ åŸºæœ¬æƒ…å ±</h2>
        <div class="form-group">
          <label for="trip-title">æ—…è¡Œã®ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ç›®çš„åœ°</label>
          <input type="text" id="trip-title" class="shared-data" placeholder="ä¾‹ï¼šçŸ³å·ã€œæ±äº¬ 2æ³Š3æ—¥æ—…è¡Œ">
        </div>
        <div class="row">
          <div class="form-group">
            <label for="date-start">å‡ºç™ºæ—¥</label>
            <input type="date" id="date-start" class="shared-data">
          </div>
          <div class="form-group">
            <label for="date-end">å¸°å®…æ—¥</label>
            <input type="date" id="date-end" class="shared-data">
          </div>
          <div class="form-group" style="flex: 0.5;">
            <label for="trip-people">å‚åŠ äººæ•°ï¼ˆäººï¼‰</label>
            <input type="number" id="trip-people" class="cost-input shared-data" placeholder="4" min="1" value="4">
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ—ºï¸ æ—¥ç¨‹è¡¨ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
        <div id="schedule-container">
          </div>
      </div>
    </div> <div class="column-right" style="display: flex; flex-direction: column; gap: 20px;">
      
      <div class="card">
        <h2>ğŸšŒ äº¤é€šã‚¢ã‚¯ã‚»ã‚¹ï¼ˆå¤œè¡Œãƒã‚¹ãƒ»æ–°å¹¹ç·šãªã©ï¼‰</h2>
        <div class="row">
          <div class="form-group">
            <label for="bus-depart-time">ã€è¡Œãã€‘ä¹—è»Šæ™‚é–“ãƒ»å ´æ‰€</label>
            <input type="text" id="bus-depart-time" class="shared-data" placeholder="23:00 é‡‘æ²¢é§…è¥¿å£">
          </div>
          <div class="form-group">
            <label for="bus-arrive-time">ã€è¡Œãã€‘åˆ°ç€æ™‚é–“ãƒ»å ´æ‰€</label>
            <input type="text" id="bus-arrive-time" class="shared-data" placeholder="06:30 ãƒã‚¹ã‚¿æ–°å®¿">
          </div>
        </div>
        <div class="row" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc;">
          <div class="form-group">
            <label for="bus-return-time">ã€å¸°ã‚Šã€‘ä¹—è»Šæ™‚é–“ãƒ»å ´æ‰€</label>
            <input type="text" id="bus-return-time" class="shared-data" placeholder="23:30 ãƒã‚¹ã‚¿æ–°å®¿">
          </div>
          <div class="form-group">
            <label for="bus-return-arrive">ã€å¸°ã‚Šã€‘åˆ°ç€æ™‚é–“ãƒ»å ´æ‰€</label>
            <input type="text" id="bus-return-arrive" class="shared-data" placeholder="07:00 é‡‘æ²¢é§…">
          </div>
        </div>
        <div class="form-group" style="margin-top: 10px;">
          <label for="bus-url">äºˆç´„ã‚µã‚¤ãƒˆã®URLãƒ»äºˆç´„ç•ªå·</label>
          <input type="text" id="bus-url" class="shared-data" placeholder="URLã‚„ã€äºˆç´„ç•ªå·123456 ãªã©">
        </div>
      </div>

      <div class="card">
        <h2>ğŸ¨ å®¿æ³Šæ–½è¨­</h2>
        <div class="form-group">
          <label for="hotel-name">ãƒ›ãƒ†ãƒ«ãƒ»å®¿ã®åå‰</label>
          <input type="text" id="hotel-name" class="shared-data" placeholder="ä¾‹ï¼šãƒ›ãƒ†ãƒ«ã€‡ã€‡æ±äº¬">
        </div>
        <div class="row">
          <div class="form-group">
            <label for="check-in">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³</label>
            <input type="time" id="check-in" class="shared-data">
          </div>
          <div class="form-group">
            <label for="check-out">ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ</label>
            <input type="time" id="check-out" class="shared-data">
          </div>
        </div>
        <div class="form-group">
          <label for="hotel-address">ä½æ‰€ãƒ»ã‚¢ã‚¯ã‚»ã‚¹ / äºˆç´„ç•ªå·</label>
          <input type="text" id="hotel-address" class="shared-data" placeholder="ä½æ‰€ã€URLã€äºˆç´„ç•ªå·ãªã©">
        </div>
      </div>

      <div class="card">
        <h2>ğŸ’´ è²»ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
        <div class="cost-grid">
          <div class="form-group">
            <label for="cost-transport">äº¤é€šè²»ï¼ˆç·é¡ï¼‰</label>
            <input type="number" id="cost-transport" class="cost-calc shared-data" placeholder="0" min="0">
          </div>
          <div class="form-group">
            <label for="cost-hotel">å®¿æ³Šè²»ï¼ˆç·é¡ï¼‰</label>
            <input type="number" id="cost-hotel" class="cost-calc shared-data" placeholder="0" min="0">
          </div>
          <div class="form-group">
            <label for="cost-food">é£Ÿè²»ãƒ»å®´ä¼šä»£ï¼ˆç·é¡ï¼‰</label>
            <input type="number" id="cost-food" class="cost-calc shared-data" placeholder="0" min="0">
          </div>
          <div class="form-group">
            <label for="cost-activity">è¦³å…‰ãƒ»ãƒã‚±ãƒƒãƒˆä»£ï¼ˆç·é¡ï¼‰</label>
            <input type="number" id="cost-activity" class="cost-calc shared-data" placeholder="0" min="0">
          </div>
        </div>
        <div class="total-box">
          æ—…è¡Œå…¨ä½“ã®æ¦‚ç®—åˆè¨ˆï¼š <input type="text" id="cost-total" readonly value="0"> å††
          <div class="per-person">
            ï¼ˆ1äººã‚ãŸã‚Šï¼šç´„ <input type="text" id="cost-per-person" readonly value="0"> å††ï¼‰
          </div>
        </div>
      </div>

    </div> <div class="card full-width">
      <h2>ğŸ’ æŒã¡ç‰©ãƒªã‚¹ãƒˆï¼ˆâ€»è‡ªåˆ†å°‚ç”¨ãƒ¡ãƒ¢ / å…±æœ‰ã•ã‚Œã¾ã›ã‚“ï¼‰</h2>
      
      <div id="checklist-container" class="checklist-group"></div>
      
      <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
        <input type="text" id="new-item-text" placeholder="æ–°ã—ã„æŒã¡ç‰©ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šã‚«ãƒ¡ãƒ©ã®å……é›»å™¨ï¼‰" style="flex: 1; max-width: 300px;">
        <button id="btn-add-item" style="padding: 10px 15px; background-color: #3498DB;">ï¼‹ è¿½åŠ </button>
      </div>
    </div>

    <div class="bottom-actions">
      <button onclick="window.print()" style="background-color: #7f8c8d;">ğŸ–¨ï¸ PDFä¿å­˜ / å°åˆ·ã—ã¦ã—ãŠã‚Šã«ã™ã‚‹</button>
      <button class="btn-danger" id="btn-clear-data" style="margin-left: 15px;">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

  </div> <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCQ5Dig1lRAz3GihBnWFJBgHTLD864QWpg",
      authDomain: "tripnavi-6363a.firebaseapp.com",
      databaseURL: "https://tripnavi-6363a-default-rtdb.firebaseio.com",
      projectId: "tripnavi-6363a",
      storageBucket: "tripnavi-6363a.firebasestorage.app",
      messagingSenderId: "946828759773",
      appId: "1:946828759773:web:990ff142a2744c55b24134"
    };

    let app, db;
    let currentSyncId = null;
    let isSyncing = false;

    // ==========================================
    // æŒã¡ç‰©ãƒªã‚¹ãƒˆã®ç®¡ç†æ©Ÿèƒ½ï¼ˆè¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¿å­˜ï¼‰
    // ==========================================
    const defaultChecklist = [
      { id: 'item-1', text: 'è²¡å¸ƒãƒ»èº«åˆ†è¨¼', checked: false },
      { id: 'item-2', text: 'ã‚¹ãƒãƒ›ãƒ»ãƒ¢ãƒã‚¤ãƒ«ãƒãƒƒãƒ†ãƒªãƒ¼', checked: false },
      { id: 'item-3', text: 'ç€æ›¿ãˆãƒ»ä¸‹ç€é¡', checked: false },
      { id: 'item-4', text: 'æ´—é¢ãƒ»ã‚¹ã‚­ãƒ³ã‚±ã‚¢ç”¨å“', checked: false },
      { id: 'item-5', text: 'å¸¸å‚™è–¬ãƒ»ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ', checked: false },
      { id: 'item-6', text: 'ãƒ‘ã‚¸ãƒ£ãƒãƒ»éƒ¨å±‹ç€', checked: false },
      { id: 'item-7', text: 'æŠ˜ã‚ŠãŸãŸã¿å‚˜', checked: false },
      { id: 'item-8', text: 'ãƒ“ãƒ‹ãƒ¼ãƒ«è¢‹ãƒ»ã‚¨ã‚³ãƒãƒƒã‚°', checked: false }
    ];

    let currentChecklist = [];

    // æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’ç”»é¢ã«æç”»ã™ã‚‹é–¢æ•°
    function renderChecklist() {
      const container = document.getElementById('checklist-container');
      container.innerHTML = '';
      
      currentChecklist.forEach(item => {
        const div = document.createElement('div');
        div.className = 'checklist-item';
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = item.id;
        checkbox.checked = item.checked;
        checkbox.addEventListener('change', (e) => {
          item.checked = e.target.checked;
          saveChecklist(); // çŠ¶æ…‹ãŒå¤‰ã‚ã‚‹ãŸã³ã«ä¿å­˜
        });

        // ãƒ©ãƒ™ãƒ«ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰
        const label = document.createElement('label');
        label.htmlFor = item.id;
        label.textContent = item.text;

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Ã—';
        deleteBtn.className = 'btn-delete-item';
        deleteBtn.title = 'ã“ã®é …ç›®ã‚’å‰Šé™¤';
        deleteBtn.addEventListener('click', () => {
          currentChecklist = currentChecklist.filter(i => i.id !== item.id);
          saveChecklist();
          renderChecklist();
        });

        div.appendChild(checkbox);
        div.appendChild(label);
        div.appendChild(deleteBtn);
        container.appendChild(div);
      });
    }

    // æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã™ã‚‹é–¢æ•°
    function saveChecklist() {
      localStorage.setItem('private-checklist', JSON.stringify(currentChecklist));
    }

    // æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
    function loadChecklist() {
      const saved = localStorage.getItem('private-checklist');
      if (saved) {
        currentChecklist = JSON.parse(saved);
      } else {
        // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ç”¨
        currentChecklist = JSON.parse(JSON.stringify(defaultChecklist));
      }
      renderChecklist();
    }

    // ã€Œï¼‹ è¿½åŠ ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†
    document.getElementById('btn-add-item').addEventListener('click', () => {
      const input = document.getElementById('new-item-text');
      const text = input.value.trim();
      if (text) {
        const newItem = {
          id: 'item-' + Date.now(), // ä¸€æ„ã®IDã‚’ç”Ÿæˆ
          text: text,
          checked: false
        };
        currentChecklist.push(newItem);
        saveChecklist();
        renderChecklist();
        input.value = ''; // å…¥åŠ›æ¬„ã‚’ç©ºã«ã™ã‚‹
      }
    });

    // Enterã‚­ãƒ¼ã§ã‚‚æŒã¡ç‰©ã‚’è¿½åŠ ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
    document.getElementById('new-item-text').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('btn-add-item').click();
      }
    });
    // ==========================================


    // è²»ç”¨ã®åˆè¨ˆã¨ã€1äººã‚ãŸã‚Šã®é‡‘é¡ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    function calculateTotal() {
      let total = 0;
      document.querySelectorAll('.cost-calc').forEach(input => {
        const val = parseInt(input.value, 10);
        if (!isNaN(val)) total += val;
      });
      document.getElementById('cost-total').value = total.toLocaleString();

      const peopleInput = document.getElementById('trip-people').value;
      const people = parseInt(peopleInput, 10);
      if (!isNaN(people) && people > 0) {
        const perPerson = Math.ceil(total / people);
        document.getElementById('cost-per-person').value = perPerson.toLocaleString();
      } else {
        document.getElementById('cost-per-person').value = "0";
      }
    }

    // æ—¥ä»˜ã«å¿œã˜ã¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ ã‚’å¢—æ¸›ãƒ»æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateScheduleDays() {
      const startStr = document.getElementById('date-start').value;
      const endStr = document.getElementById('date-end').value;
      const container = document.getElementById('schedule-container');
      
      let days = 3; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯3æ—¥é–“
      let startDate = null;

      if (startStr) {
        startDate = new Date(startStr);
      }

      if (startStr && endStr) {
        const end = new Date(endStr);
        const diff = (end - startDate) / (1000 * 60 * 60 * 24);
        if (diff >= 0 && diff <= 30) {
          days = diff + 1;
        } else if (diff < 0) {
          days = 1;
        }
      }

      const currentDays = container.querySelectorAll('.schedule-day').length;

      if (days > currentDays) {
        for (let i = currentDays + 1; i <= days; i++) {
          addScheduleDay(i, container);
        }
      } else if (days < currentDays) {
        for (let i = currentDays; i > days; i--) {
          const el = document.getElementById(`schedule-day-wrapper-${i}`);
          if (el) el.remove();
        }
      }

      for (let i = 1; i <= days; i++) {
        const wrapper = document.getElementById(`schedule-day-wrapper-${i}`);
        if (wrapper) {
          const title = wrapper.querySelector('h3');
          let dateText = '';
          if (startDate) {
            const d = new Date(startDate);
            d.setDate(d.getDate() + i - 1);
            const month = d.getMonth() + 1;
            const date = d.getDate();
            const daysOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const dayOfWeek = daysOfWeek[d.getDay()];
            dateText = ` ï¼ˆ${month}/${date} ${dayOfWeek}ï¼‰`;
          }
          title.textContent = `Day ${i}${dateText}`;
        }
      }
    }

    function addScheduleDay(dayNum, container) {
      const wrapper = document.createElement('div');
      wrapper.className = 'schedule-day';
      wrapper.id = `schedule-day-wrapper-${dayNum}`;
      
      const title = document.createElement('h3');
      title.textContent = `Day ${dayNum}`;
      wrapper.appendChild(title);
      
      const textarea = document.createElement('textarea');
      textarea.id = `schedule-day${dayNum}`;
      textarea.className = 'shared-data';
      
      if (dayNum === 1) textarea.placeholder = "ä¾‹ï¼š\n22:30 é‡‘æ²¢é§…è¥¿å£ é›†åˆ\n23:00 å¤œè¡Œãƒã‚¹å‡ºç™º";
      else textarea.placeholder = `ä¾‹ï¼š\nDay ${dayNum} ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«`;
      
      wrapper.appendChild(textarea);
      container.appendChild(wrapper);

      const savedData = localStorage.getItem(textarea.id);
      if (savedData) textarea.value = savedData;
    }

    // åŒæœŸå‡¦ç†ã‚’ã¾ã¨ã‚ãŸé–¢æ•°
    function startSync(shareId, isAuto = false) {
      if (!app) {
        try {
          app = initializeApp(firebaseConfig);
          db = getDatabase(app);
        } catch (error) {
          if (!isAuto) alert("Firebaseã®æ¥ç¶šã‚¨ãƒ©ãƒ¼ã§ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          console.error(error);
          return;
        }
      }

      currentSyncId = shareId;
      isSyncing = true;
      localStorage.setItem('savedSyncId', shareId);
      document.getElementById('sync-status-text').style.display = 'inline-block';
      
      const tripRef = ref(db, 'trips/' + currentSyncId);
      const initialData = {};
      
      document.querySelectorAll('.shared-data').forEach(input => {
        if (input.value) initialData[input.id] = input.value;
      });
      if (Object.keys(initialData).length > 0) {
        update(tripRef, initialData);
      }

      onValue(tripRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          let dateChanged = false;
          if (data['date-start'] !== undefined && document.activeElement.id !== 'date-start') {
            document.getElementById('date-start').value = data['date-start'];
            dateChanged = true;
          }
          if (data['date-end'] !== undefined && document.activeElement.id !== 'date-end') {
            document.getElementById('date-end').value = data['date-end'];
            dateChanged = true;
          }
          if (dateChanged) updateScheduleDays();

          document.querySelectorAll('.shared-data').forEach(input => {
            if (data[input.id] !== undefined && document.activeElement !== input) {
              input.value = data[input.id];
              localStorage.setItem(input.id, input.value);
            }
          });
          calculateTotal();
        }
      });
      
      if (!isAuto) {
        alert(`IDã€Œ${shareId}ã€ã§åŒæœŸã‚’é–‹å§‹ã—ã¾ã—ãŸï¼`);
      }
    }

    // æ‰‹å‹•ã§æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹æ©Ÿèƒ½
    document.getElementById('btn-refresh').addEventListener('click', () => {
      if (!isSyncing || !currentSyncId) {
        alert("åŒæœŸãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…±æœ‰IDã‚’å…¥åŠ›ã—ã¦åŒæœŸã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      
      const tripRef = ref(db, 'trips/' + currentSyncId);
      
      get(tripRef).then((snapshot) => {
        if (snapshot.exists()) {
          const data = snapshot.val();
          
          let dateChanged = false;
          if (data['date-start'] !== undefined) {
            document.getElementById('date-start').value = data['date-start'];
            dateChanged = true;
          }
          if (data['date-end'] !== undefined) {
            document.getElementById('date-end').value = data['date-end'];
            dateChanged = true;
          }
          if (dateChanged) updateScheduleDays();

          document.querySelectorAll('.shared-data').forEach(input => {
            if (data[input.id] !== undefined) {
              input.value = data[input.id];
              localStorage.setItem(input.id, input.value);
            }
          });
          calculateTotal();
          
          const btn = document.getElementById('btn-refresh');
          const originalText = btn.innerHTML;
          btn.innerHTML = "âœ¨ æ›´æ–°å®Œäº†ï¼";
          setTimeout(() => { btn.innerHTML = originalText; }, 2000);
        } else {
          alert("å…±æœ‰ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
        }
      }).catch((error) => {
        console.error(error);
        alert("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
      });
    });

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', () => {
      // 1. æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
      loadChecklist();

      // 2. æ—¥ä»˜ã‚’å¾©å…ƒã™ã‚‹
      ['date-start', 'date-end'].forEach(id => {
        const savedData = localStorage.getItem(id);
        if (savedData !== null) {
          document.getElementById(id).value = savedData;
        }
      });
      
      // 3. å¾©å…ƒã—ãŸæ—¥ä»˜ã‚’ã‚‚ã¨ã«ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ ã‚’å¿…è¦ãªæ•°ã ã‘ç”Ÿæˆã™ã‚‹
      updateScheduleDays();

      // 4. ãã®ä»–ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã™ã‚‹
      document.querySelectorAll('input:not(#share-id):not(#cost-total):not(#cost-per-person):not(#new-item-text), textarea').forEach(input => {
        if (input.id === 'date-start' || input.id === 'date-end') return;
        
        const savedData = localStorage.getItem(input.id);
        if (savedData !== null) {
          if (input.type === 'checkbox') {
            input.checked = (savedData === 'true');
          } else {
            input.value = savedData;
          }
        }
      });
      calculateTotal();

      const savedSyncId = localStorage.getItem('savedSyncId');
      if (savedSyncId) {
        document.getElementById('share-id').value = savedSyncId;
        startSync(savedSyncId, true);
      }
    });

    // ç”»é¢ä¸Šã®ã‚ã‚‰ã‚†ã‚‹å…¥åŠ›å¤‰æ›´ã‚’æ¤œçŸ¥ã™ã‚‹ï¼ˆæŒã¡ç‰©è¿½åŠ ç”¨ã®inputãªã©ã¯é™¤å¤–ï¼‰
    document.addEventListener('input', (e) => {
      const input = e.target;
      
      if (!input.matches('input:not(#share-id):not(#cost-total):not(#cost-per-person):not(#new-item-text), textarea')) return;
      if (input.type === 'checkbox' && input.closest('#checklist-container')) return; // æŒã¡ç‰©ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯å°‚ç”¨å‡¦ç†ã§ä¿å­˜

      // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
      if (input.type === 'checkbox') {
        localStorage.setItem(input.id, input.checked);
      } else {
        localStorage.setItem(input.id, input.value);
      }

      if (input.classList.contains('cost-calc') || input.id === 'trip-people') {
        calculateTotal();
      }

      if (input.id === 'date-start' || input.id === 'date-end') {
        updateScheduleDays();
      }

      if (isSyncing && input.classList.contains('shared-data')) {
        const tripRef = ref(db, 'trips/' + currentSyncId);
        update(tripRef, { [input.id]: input.value });
      }
    });

    document.getElementById('btn-start-sync').addEventListener('click', () => {
      const shareId = document.getElementById('share-id').value.trim();
      if (!shareId) {
        alert("å…±æœ‰IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      startSync(shareId, false);
    });

    document.getElementById('btn-clear-data').addEventListener('click', () => {
      if (confirm('å…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆâ€»åŒæœŸä¸­ã®å ´åˆã€å…±æœ‰å…ˆã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆå»ã•ã‚Œã¾ã™ï¼‰')) {
        // é€šå¸¸ã®å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
        document.querySelectorAll('input:not(#share-id):not(#cost-total):not(#cost-per-person):not(#new-item-text), textarea').forEach(input => {
          if (input.type === 'checkbox') {
            input.checked = false;
          } else if (input.id === 'trip-people') {
            input.value = '4'; // äººæ•°ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®4ã«æˆ»ã™
          } else {
            input.value = '';
          }
          localStorage.removeItem(input.id);
        });
        
        // æŒã¡ç‰©ãƒªã‚¹ãƒˆã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
        localStorage.removeItem('private-checklist');
        currentChecklist = JSON.parse(JSON.stringify(defaultChecklist));
        renderChecklist();
        
        updateScheduleDays();

        localStorage.removeItem('savedSyncId');
        document.getElementById('share-id').value = '';
        document.getElementById('sync-status-text').style.display = 'none';

        calculateTotal();

        if (isSyncing && currentSyncId) {
          const tripRef = ref(db, 'trips/' + currentSyncId);
          remove(tripRef);
        }
        
        isSyncing = false;
        currentSyncId = null;
        window.scrollTo(0, 0);
      }
    });
  </script>
</body>
</html>